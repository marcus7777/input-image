<link rel="import" href="../image-base64/image-base64.html">
<link rel="import" href="../load-image/load-image.html">
<!--
  `<input-image></input-image>` Convert and resize an image to the size you need and exposes it is a string
  @demo demo.html
-->
<dom-module id="input-image">
  <template>
    <template is="dom-if" if="[[value]]">
      <img style="max-width:200px" src="{{value}}" on-load="ready" on-tap="remove" />
    </template>
    <template is="dom-if" if="[[!value]]">
      <load-image exif="{{exif}}" orientation="{{orientation}}" label="{{label}}" src="{{big}}"></load-image>
    </template>
    <template is="dom-if" if="[[gps]]">
      <a target='_blank' href$='https://www.google.co.uk/maps/search/[[gps]]' >Map link</a>
    </template>
    <template is="dom-if" if="[[big]]">
      <image-base64 log="[[log]]" hidden="{{!value}}" orientation="[[orientation]]" url="{{big}}" base64="{{value}}" width="[[width]]" max-height="{{maxHeight}}" max-width="[[maxWidth]]"></image-base64>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "input-image",
    properties:{
      value:{
        notify: true, type: String, value: "",
      },
      width: {
        value: 200, type:Number,
      },
      setWidth: {
        value: 200, type:Number,
      },
      big: {
        type: String
      },
      log: {
        type: Boolean,
        value: false
      },
      title: {
        computed:"exifToInfo(exif)"
      },
      gps: {
        notify: true,
      },
    },
    exifToInfo: function(exif) {
      var output = ""
      var toDecimal = function (number) {
         return (
           number[0].numerator + number[1].numerator / (60 * number[1].denominator) + 
           number[2].numerator / (3600 * number[2].denominator)
         ).toFixed(7)
      }
      if (exif) {
        if (exif.Make + exif.Model) {
          output = "Photo taken on a " + exif.Make + " " + exif.Model
        }
        if (exif.GPSLongitude + exif.GPSLatitude) {
          var ll = toDecimal(exif.GPSLongitude) + exif.GPSLongitudeRef + "," + toDecimal(exif.GPSLatitude) + exif.GPSLatitudeRef
          output = output + " with the longitude and latitude of : " + ll + "; "
          this.gps = ll
        } else {
          this.gps = ""
        }
        if (exif.Flash) {
          output = output + " " + exif.Flash
        }
        return output
      } else  {
        return "No exif data was detected"
      }
    },
    remove: function (){
      this.value = ""
      this.big = ""
      this.set("width", this.setWidth)
      this.orientation = 1
    },
    ready: function (){
      if (!this.big) {
        this.big = this.value
   //   } else if (this.big !== this.value) { TODO why?
   //     this.big = this.value
      }
    },
  })
</script>
